---
---
{% include menu.html title="Code Medallion Architecture in Delta Lake" % }

<body>
    <table width=900><tr><td>    
    <h1>Code Medallion Architecture in Delta Lake</h1>

    <h3>PySpark Code Example:</h3>

    <pre><code><span class="comment"># Initialize Spark session with Delta support</span>
<span class="datatype">spark</span> = SparkSession.builder \
    .<span class="function">appName</span>(<span class="string">"Medallion Architecture"</span>) \
    .<span class="keyword">config</span>(<span class="string">"spark.sql.extensions"</span>, <span class="string">"io.delta.sql.DeltaSparkSessionExtension"</span>) \
    .<span class="keyword">config</span>(<span class="string">"spark.sql.catalog.spark_catalog"</span>, <span class="string">"org.apache.spark.sql.delta.catalog.DeltaCatalog"</span>) \
    .<span class="function">getOrCreate</span>()

<span class="comment"># Paths for the Bronze, Silver, and Gold layers</span>
<span class="keyword">bronze_path</span> = <span class="string">"/mnt/delta/bronze"</span>
<span class="keyword">silver_path</span> = <span class="string">"/mnt/delta/silver"</span>
<span class="keyword">gold_path</span>   = <span class="string">"/mnt/delta/gold"</span>

<span class="comment"># ----------- Bronze Layer (Raw Data Ingestion) ----------------------------- #</span>
<span class="keyword">raw_data</span> = spark.<span class="function">read</span>().<span class="keyword">format</span>(<span class="string">"json"</span>).<span class="function">load</span>(<span class="string">"/mnt/raw_data/"</span>)
<span class="keyword">raw_data</span>.<span class="function">write</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="keyword">mode</span>(<span class="string">"overwrite"</span>).<span class="function">save</span>(<span class="keyword">bronze_path</span>)

<span class="comment"># ----------- Silver Layer (Data Cleaning and Transformation) --------------- #</span>
<span class="datatype">bronze_df</span> = spark.<span class="function">read</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="function">load</span>(<span class="keyword">bronze_path</span>)
<span class="datatype">silver_df</span> = <span class="datatype">bronze_df</span>.<span class="function">dropDuplicates</span>().<span class="function">filter</span>(col(<span class="string">"status"</span>).<span class="function">isNotNull</span>())
<span class="datatype">silver_df</span>.<span class="function">write</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="keyword">mode</span>(<span class="string">"overwrite"</span>).<span class="function">save</span>(<span class="keyword">silver_path</span>)

<span class="comment"># ----------- Gold Layer ( Aggregated and Optimized Data ) ------------------ #</span>
<span class="datatype">silver_df</span> = spark.<span class="function">read</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="function">load</span>(<span class="keyword">silver_path</span>)
<span class="datatype">gold_df</span> = <span class="datatype">silver_df</span>.<span class="function">groupBy</span>(<span class="string">"category"</span>) \
                   .<span class="function">agg</span>(<span class="function">count</span>(<span class="string">"order_id"</span>).<span class="keyword">alias</span>(<span class="string">"total_orders"</span>), \
                    <span class="function">sum</span>(<span class="string">"sales_amount"</span>).<span class="keyword">alias</span>(<span class="string">"total_sales"</span>))
<span class="datatype">gold_df</span>.<span class="function">write</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="keyword">mode</span>(<span class="string">"overwrite"</span>).<span class="function">save</span>(<span class="keyword">gold_path</span>)

<span class="keyword">spark.stop</span>()
</code></pre>

    <ol>
        <li><h3>Bronze Layer: Raw Data Ingestion</h3>
            <ul>
                <li>Step 1: Load raw data into the Bronze layer (e.g., from a JSON file).
                    <pre><code><span class="keyword">raw_data</span> = spark.<span class="function">read</span>().<span class="keyword">format</span>(<span class="string">"json"</span>).<span class="function">load</span>(<span class="string">"/mnt/raw_data/"</span>)</code></pre>
                </li>
                <li>Step 2: Write the raw data into the Bronze Delta table.
                    <pre><code><span class="keyword">raw_data</span>.<span class="function">write</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="keyword">mode</span>(<span class="string">"overwrite"</span>).<span class="function">save</span>(<span class="keyword">bronze_path</span>)</code></pre>
                </li>
            </ul>
        </li>

        <li><h3>Silver Layer: Data Cleaning and Transformation</h3>
            <ul>
                <li>Step 3: Read data from the Bronze layer into the Silver layer for cleaning.
                    <pre><code><span class="datatype">bronze_df</span> = spark.<span class="function">read</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="function">load</span>(<span class="keyword">bronze_path</span>)</code></pre>
                </li>
                <li>Step 4: Clean data by removing duplicates and filtering.
                    <pre><code><span class="datatype">silver_df</span> = <span class="datatype">bronze_df</span>.<span class="function">dropDuplicates</span>().<span class="function">filter</span>(col(<span class="string">"status"</span>).<span class="function">isNotNull</span>())</code></pre>
                </li>
                <li>Step 5: Write the cleaned data into the Silver Delta table.
                    <pre><code><span class="datatype">silver_df</span>.<span class="function">write</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="keyword">mode</span>(<span class="string">"overwrite"</span>).<span class="function">save</span>(<span class="keyword">silver_path</span>)</code></pre>
                </li>
            </ul>
        </li>

        <li><h3>Gold Layer: Aggregated and Optimized Data</h3>
            <ul>
                <li>Step 6: Read data from the Silver layer and perform aggregations.
                    <pre><code><span class="datatype">silver_df</span> = spark.<span class="function">read</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="function">load</span>(<span class="keyword">silver_path</span>)</code></pre>
                </li>
                <li>Step 7: Aggregate data for reporting.
                    <pre><code><span class="datatype">gold_df</span> = <span class="datatype">silver_df</span>.<span class="function">groupBy</span>(<span class="string">"category"</span>) \
                        .<span class="function">agg</span>(<span class="function">count</span>(<span class="string">"order_id"</span>).<span class="keyword">alias</span>(<span class="string">"total_orders"</span>), \
                        <span class="function">sum</span>(<span class="string">"sales_amount"</span>).<span class="keyword">alias</span>(<span class="string">"total_sales"</span>))</code></pre>
                </li>
                <li>Step 8: Write the aggregated data into the Gold Delta table.
                    <pre><code><span class="datatype">gold_df</span>.<span class="function">write</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="keyword">mode</span>(<span class="string">"overwrite"</span>).<span class="function">save</span>(<span class="keyword">gold_path</span>)</code></pre>
                </li>
            </ul>
        </li>
    </ol>


</td></tr></table>

  {% include footer.html %}

  </body>
</html>
