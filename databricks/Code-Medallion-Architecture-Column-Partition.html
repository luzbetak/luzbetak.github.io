---
---
{% include menu.html title="Medallion Architecture Example with Delta Lake" %}


<h1>Medallion Architecture Example with Delta Lake</h1>

<pre>
<span class="keyword">from</span> pyspark.sql <span class="keyword">import</span> SparkSession
<span class="keyword">from</span> pyspark.sql.functions <span class="keyword">import</span> col, current_date, date_sub, sum, count

spark = SparkSession.builder \
    .appName(<span class="string">"Medallion Architecture Example"</span>) \
    .config(<span class="string">"spark.sql.extensions"</span>, <span class="string">"io.delta.sql.DeltaSparkSessionExtension"</span>) \
    .config(<span class="string">"spark.sql.catalog.spark_catalog"</span>, <span class="string">"spark.sql.delta.catalog.DeltaCatalog"</span>) \
    .getOrCreate()

<span class="comment"># Define paths for Bronze, Silver, and Gold layers</span>
bronze_path = <span class="string">"/mnt/delta/bronze"</span>
silver_path = <span class="string">"/mnt/delta/silver"</span>
gold_path   = <span class="string">"/mnt/delta/gold"</span>

<span class="comment"># ------------------- Bronze Layer (Raw Data Ingestion) ------------------------------ #</span>
raw_data = spark.read().format(<span class="string">"json"</span>).load(<span class="string">"/mnt/raw_data/"</span>)
raw_data = raw_data.repartition(256, col(<span class="string">"date"</span>))
raw_data.write().format(<span class="string">"delta"</span>).mode(<span class="string">"overwrite"</span>).partitionBy(<span class="string">"date"</span>).save(bronze_path)

<span class="comment"># ------------------ Silver Layer (Filter Data by Date) ----------------------------- #</span>
bronze_df = spark.read().format(<span class="string">"delta"</span>).load(bronze_path)
days = 7
silver_df = bronze_df.filter(
    (col(<span class="string">"date"</span>) >= date_sub(current_date(), days)) & (col(<span class="string">"date"</span>) <= current_date())
)
silver_df.write().format(<span class="string">"delta"</span>).mode(<span class="string">"overwrite"</span>).save(silver_path)

<span class="comment"># ----------------- Gold Layer (Aggregation and Optimization) ---------------------- #</span>
silver_df = spark.read().format(<span class="string">"delta"</span>).load(silver_path)
gold_df = silver_df.groupBy(<span class="string">"category"</span>) \
                   .agg(count(<span class="string">"order_id"</span>).alias(<span class="string">"total_orders"</span>),
                   sum(<span class="string">"sales_amount"</span>).alias(<span class="string">"total_sales"</span>))
gold_df.write().format(<span class="string">"delta"</span>).mode(<span class="string">"overwrite"</span>).save(gold_path)

spark.stop()
</pre>


<hr>

<h1>Medallion Architecture with PySpark Example</h1>

    <ol>
        <li><h3>Bronze Layer (Raw Data Ingestion)</h3>
            <ul>
                <li><strong>Step 1:</strong> Load raw data from a JSON source.
                    <pre><code><span class="datatype">raw_data</span> = spark.<span class="function">read</span>().<span class="keyword">format</span>(<span class="string">"json"</span>).<span class="function">load</span>(<span class="string">"/mnt/raw_data/"</span>)</code></pre>
                </li>
                <li><strong>Step 2:</strong> Repartition the data by the <code>date</code> column to distribute it efficiently.
                    <pre><code><span class="datatype">raw_data</span> = <span class="datatype">raw_data</span>.<span class="function">repartition</span>(256, col(<span class="string">"date"</span>))</code></pre>
                </li>
                <li><strong>Step 3:</strong> Write the repartitioned data to the Bronze Delta table, partitioned by the <code>date</code> column.
                    <pre><code><span class="datatype">raw_data</span>.<span class="function">write</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="keyword">mode</span>(<span class="string">"overwrite"</span>).<span class="keyword">partitionBy</span>(<span class="string">"date"</span>).<span class="function">save</span>(<span class="keyword">bronze_path</span>)</code></pre>
                </li>
            </ul>
        </li>

        <li><h3>Silver Layer (Filter Data by Date)</h3>
            <ul>
                <li><strong>Step 4:</strong> Read the data from the Bronze Delta table.
                    <pre><code><span class="datatype">bronze_df</span> = spark.<span class="function">read</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="function">load</span>(<span class="keyword">bronze_path</span>)</code></pre>
                </li>
                <li><strong>Step 5:</strong> Filter data for records within the last 7 days (between <code>today</code> and <code>today - 7 days</code>).
                    <pre><code><span class="datatype">days</span> = 7
<span class="datatype">silver_df</span> = <span class="datatype">bronze_df</span>.<span class="function">filter</span>(
    (col(<span class="string">"date"</span>) >= date_sub(current_date(), <span class="datatype">days</span>)) & 
    (col(<span class="string">"date"</span>) <= current_date())
)</code></pre>
                </li>
                <li><strong>Step 6:</strong> Write the filtered data to the Silver Delta table.
                    <pre><code><span class="datatype">silver_df</span>.<span class="function">write</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="keyword">mode</span>(<span class="string">"overwrite"</span>).<span class="function">save</span>(<span class="keyword">silver_path</span>)</code></pre>
                </li>
            </ul>
        </li>

        <li><h3>Gold Layer (Aggregation and Optimization)</h3>
            <ul>
                <li><strong>Step 7:</strong> Read the filtered data from the Silver Delta table.
                    <pre><code><span class="datatype">silver_df</span> = spark.<span class="function">read</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="function">load</span>(<span class="keyword">silver_path</span>)</code></pre>
                </li>
                <li><strong>Step 8:</strong> Perform aggregation (e.g., total orders and sales by category).
                    <pre><code><span class="datatype">gold_df</span> = <span class="datatype">silver_df</span>.<span class="function">groupBy</span>(<span class="string">"category"</span>) \
    .<span class="function">agg</span>(count(<span class="string">"order_id"</span>).<span class="keyword">alias</span>(<span class="string">"total_orders"</span>), \
         sum(<span class="string">"sales_amount"</span>).<span class="keyword">alias</span>(<span class="string">"total_sales"</span>))</code></pre>
                </li>
                <li><strong>Step 9:</strong> Write the aggregated data to the Gold Delta table.
                    <pre><code><span class="datatype">gold_df</span>.<span class="function">write</span>().<span class="keyword">format</span>(<span class="string">"delta"</span>).<span class="keyword">mode</span>(<span class="string">"overwrite"</span>).<span class="function">save</span>(<span class="keyword">gold_path</span>)</code></pre>
                </li>
            </ul>
        </li>
    </ol>


  {% include footer.html %}

  </body>
</html>
